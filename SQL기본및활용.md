# SQL 기본 및 활용

## 트랜잭션
데이터베이스의 논리적 연산단위로서 밀접히 관련되어 분리될 수 없는 1개 이상의 데이터베이스 조작

### 트랜잭션의 특징
1. 원자성 : 트랜잭션에 정의된 연산들은 모두 성공적으로 실행되던지 아니면 전혀 실행되지 않은 상태로 남아 있어야 한다.
2. 일관성 : 트랜잭션이 실행되기 전의 데이터베이스 내용이 잘못 되어 있지 않다면 트랜잭션이 실행된 이후에도 데이터베이스의 내용에 잘못이 있으면 안된다.
3. 고립성/독립성 : 트랜잭션이 실행되는 도중에 다른 트랜잭션의 영향을 받아 잘못된 결과를 만들어선 안된다.
4. 지속성 : 트랜잭션이 성공적으로 수행되면 그 트랜잭션이 갱신한 데이터베이스의 내용은 영구적으로 저장된다.

### 트랜잭션 정리
- 데이터의 변경을 발생시키는 DML 언어 수행 시 데이터의 무결성을 보장하는 것이 커밋과 롤백의 목적
- 커밋은 변경된 데이터를 테이블이 영구적으로 반영한다는 의미
- 롤백은 변경 사항을 취소하고 변경 이전의 데이터로 복구하라는 의미
- Savepoint 는 데이터 변경을 사전에 지정한 저장점까지만 롤백하라는 의미
- 트랜잭션은 대상이 되는 SQL문을 실행하면 자동으로 시작하고 커밋 또는 롤백을 실행한 시점에 종료된다.



## SQL 문장 종류
### DDL (Data Definition Language) 데이터 정의어
Creat, Alter, Drop, Rename ... <br/>
테이블과 같은 데이터 구조를 정의하는데 사용되는 명령어들로 그러한 구조를 생성하거나 변경하거나 삭제하거 이름을 바꾸는 데이터 구조와 관련된 명령어

#### 제약조건
무결성을 지키기 위해 사용
#### 제약조건의 종류
1. 고유키 (Unique Key) : 중복되지 않는 키, Null 이 가능하나 행을 구별할 수 있어야 한다.
2. 기본키 (Primary Key) : 중복되지 않으면서 Null이 아닌 키 -> 하나의 테이블에 하나의 기본키
3. 외래키 (Foreign Key) : 기본키를 가져와서 쓰는 키, 테이블 간 관계를 정의하기 위해 기본키를 다른 테이블의 외래키로 복사
  -  참조 무결성 제약 조건 선택이 가능하다. -> 삭제하려고 하는 테이블이나 데이터가 외부 다른 테이블에서 참조되고 있다면 삭제가 불가능하게 제약 (Restrict/Cascade)
4. Not Null : 값이 Null 이 아닌 키
5. Check : 입력값이 조건에 맞는지 확인

#### Alter table 테이블명 (Alter/Add/Drop) ...
- Alter table 테이블명 Alter/Modify Column (컬럼명 데이터유형) ...
- Alter table 테이블명 Drop Column 삭제할컬럼명 ... : 불필요한 컬럼 삭제
- Alter table 테이블명 Add Column ...
- Alter table 테이블명 Rename Column ...

#### Rename 테이블명 To 바꿀테이블명

#### Truncate
테이블의 데이터를 전부 삭제하고 사용하고 있던 공간을 반납
- 해당 테이블의 데이터가 모두 삭제되지만 테이블 자체가 지워지는 것이 아님, 즉 컬럼값은 남아있지만 튜플은 없는 상태이다.
- 해당 테이블에 생성되어 있던 인덱스도 함께 truncate
- Delete 보다 Truncate 가 좋아보이나 원하는 데이터만 골라 삭제가 불가능 하다.

#### Drop
테이블 자체를 삭제하는 명령어
- 테이블 자체가 모두 지워지며, 해당 테이블에 생성되어 있던 인덱스도 삭제됨
- 테이블 자체가 사라지는 것이므로 데이터도 삭제되고, 사용하던 공간도 모두 반납한다. 제약 조건 등도 삭제된다.


### DML(Data Manipulation Language) 데이터 조작어
- Select : 데이터베이스에 들어 있는 데이터를 조회하거나 검색하기 위한 명령어 - Retrieve 라고도 함
- Insert, Update, Delete ...<br/>
데이터베이스의 테이블에 들어있는 데이터에 변형을 가하는 종류의 명령어들을 의미

#### Select
- Distinct : 중복 요소 제거
- As : Alias, 별칭 지정

#### Update 테이블명 set 칼럼명=값

#### Insert into 테이블명 (컬럼명) values 값

#### Where 조건절
- 자신이 원하는 자료만 검색하기 위해 자료들에 대해 제한
- 연산자의 종류
  - 비교 연산자 : <, >, ^=, !=
  - SQL 연산자
    - Between A and B
    - In
    - Like '문자열'
    - Is Null
    - Not Between A and B
    - Not in
    - Is not null
  - 논리 연산자
    - And, Or, Not
  - 연산자 우선 순위
    1. 괄호
    2. 비교 연산자, SQL 연산자
    3. Not 연산자
    4. And
    5. Or

#### 문자 유형 크기 비교 방법 (양쪽이 모두 Char 타입인 경우)
1. 길이가 서로 다르면 작은 쪽에 공백을 추가하여 길이를 같게 한다.
2. 서로 다른 문자가 나올 때까지 비교
3. 달라진 첫번째 값에 따라 크기를 결정 (AscII)
4. 공백의 수만 다르다면 같은 값으로 결정 -> 'ABC', 'ABC ' 같은 것으로 판단

#### 문자 유형 크기 비교 방법 (비교 연산자 중 한쪽이 Varchar인 경우)
1. 서로 다른 문자가 나올 때까지 비교
2. 길이가 서로 다르면 짧은 것이 끝날 때까지만 비교
3. 길이가 긴 것이 크다고 판단
4. 길이가 같고 다른 것이 없다면 같다고 판단
5. Varchar 는 공백도 문자로 판단 -> 'ABC', 'ABC ' 다른 것으로 판단

#### 문자 유형 크기 비교 방법 (상수값과 비교)
1. 상수쪽을 변수 타입과 동일하게 바꾸고 비교
2. 변수가 Char면 Char 유형 타입의 경우를 적용
3. 변수가 Varchar면 Varchar 유형을 적용


### DCL (Data Control Language) 데이터 제어어
Grant, Revoke ... <br/>
데이터베이스에 접근하고 객체들을 사용하도록 권한을 주고 회수하는 명령어


### TCL (Transaction Control Language) 트랜잭션 제어어
Commit, Rollback ... <br/>
논리적인 작업의 단위를 묶어서 DML에 의해 조작된 결과를 트랜잭션(작업단위)별로 제어하는 명령어
* 다만, SQL 서버는 기본적으로 Auto Commit 모드이므로 DML 수행 후 TCL 을 처리할 필요가 없다.
* Oracle 예외

#### Commit
- DML 구문이 성공할 때,
- 데이터에 대한 변경사항을 데이터베이스에 영구적으로 저장

#### Rollback
- DML 구문에 오류가 있을 때
- 데이터에 대한 변경사항을 모두 폐기하고 변경 전 상태로 되돌리는 명령
- 테이블 내 입력한 데이터나 수정한 데이터, 삭제한 데이터에 대하여 Commit 이전에는 변경사항을 취소할 수 있는데, 이를 Rollback 하는 것
- 데이터 변경 사항이 취소되어 데이터 이전 상태로 복구되며, 관련된 향에 대한 Locking 이 풀리고 다른 사용자들이 데이터 변경을 할 수 있게 된다.
- 커밋 되지 않은 상태의 모든 트랜잭션을 롤백하는 것이다.
- 최초의 Begin Transation 시점까지 Rollback 이 수행됨
```
Begin Transaction : 트랜잭션 실행
Commit Transaction / Rollback Transaction : 트랜잭션 종료
```

#### 트랜잭션 완료의 의미
1. 변경사항이 데이터베이스에 반영
2. 이전 데이터가 영영 사라져버린다.
3. 모든 사용자는 결과를 볼 수 있다.
4. 관련 행은 잠금이 풀리고 다른 사용자가 변경 가능하다.

#### Commit/Rollback 이전의 데이터 상태
1. 메모리 Buffer만 쌓여있으므로 데이터 변경 이전 상태로 복구 가능
2. 현재 사용자는 Select 문장으로 결과 확인 가능
3. 다른 사용자는 현재 사용자가 수행한 명령의 결과를 볼 수 없다.
4. 변경된 행은 잠금이 설정되어서 다른 사용자가 변경할 수 없다.

#### 커밋/롤백을 실행하지 않아도 자동으로 트랜잭션이 종료되는 경우
1. Create, Alter, Drop, Rename, Truncate table 등의 DDL 언어를 수행 시 전후 시점에 자동 커밋
2. DML 문장 이후 커밋 없이 DDL 문장이 실행되면 자동 커밋
3. 데이터베이스를 정상적으로 접속 종료하면 자동 커밋
4. 애플리케이션의 이상 종료로 데이터베이스와의 접속이 단절되었을 때 트랜지션이 자동 롤백

#### Savepoint
롤백할 때 트랜잭션에 포함된 전체 작업을 롤백하는 것이 아닌, 현 시점의 Savepoint 까지 트랜잭션의 일부만 롤백해준다.



## 관계형 데이터베이스
### 테이블 생성 주의사항
- 테이블명은 객체를 의미할 수 있는 적절한 이름, 단수형
- 테이블명은 다른 이름과 중복되지 않도록
- 한 테이블 내에는 컬럼명이 중복되게 지정할 수 없음
- 테이블 이름을 지정하고 각 칼럼들은 괄호로 묶어 지정
- 각 컬럼들은 콤마로 구분되고 테이블 생성문의 끝은 항상 세미콜롬으로 마친다.
- 컬럼에 대해선 다른 테이블까지 고려하여 데이터베이스 내에서 일관성있게 사용
- 컬럼 뒤에 데이터 유형은 꼭 지정되어야 한다
- 테이블명과 컬럼명은 반드시 문자로 시작해야하고 벤더별로 길이에 대한 한계가 있다.
- 벤더에서 사전에 정의한 예약어는 불가하다
- A-Z, a-z, 0-9, _, $, # 문자만 허용

### 제약조건 (Constraint)
- Check 제약 조건은 데이터베이스에서 데이터의 무결성을 유지하기 위해 테이블의 특정 컬럼에 설정하는 제약
- 기본키는 반드시 테이블 당 하나의 제약만을 정의할 수 있다.
- 고유키로 지정된 모든 컬럼들은 null 값을 가질 수 있다.
- 외래키는 테이블간의 관계를 정의하기 위해 기본키를 다른 테이블의 외래키가 참조하도록 생성


## 분산 데이터베이스
<-> 통합 데이터베이스 / GSI (Global Single Instance)
### 장점
1. 지역 자치성, 점증적 시스템 용량 확장
2. 신뢰성과 가용성
3. 효용성, 웅통성
4. 빠른 응답 속도와 통신 비용 절감
5. 시스템 규모의 적절한 조절
6. 각 지역 사용자의 요구 사용 증대

### 단점
1. 소프트웨어 개발 비용 상승
2. 오류의 잠재성 증대
3. 처리 비용 상승
4. 설계, 관리의 복잡성과 비용 상승
5. 불규칙한 응답 속도
6. 통제의 어려움
7. 데이터 무결성에 대한 위협
- 공통코드 기준정보 등 마스터 데이터를 1곳에 두고 운영하는 경우 원격자에게 접근이 빈번할수록 실시간 업무처리 성능이 나쁠 수 있으므로 분산 환경에서 복제 분산을 하는 법으로 분산 데이터베이스를 구성 가능하다.
- 백업 사이트 구성에 대해서 분산 환경으로 구성 가능


## 참조 동작 (Referential Action)
### Delete/Modify Action
1. Cascade : 참조하는 자식도 같이 삭제
2. Restrict : 자식 테이블에 PK값이 없는 경우만 삭제 허용, PK가 있으면 취소됨
3. Set Null : 마스터 삭제 시 자식 해당 필드 Null 처리
4. Set Default : 마스터 삭제 시 자식 해당 필드 Default 값으로 설정

### Insert Action
1. Automatic : 마스터 테이블에 PK가 없는 경우 마스터 PK를 생성하고 자식 입력
2. Set Null : 마스터 테이블에 PK가 없는 경우 자식 외부키를 Null 로 처리
3. Set Default : 마스터 테이블에 PK가 없는 경우 자식 외부키를 Default 로 설정
4. Dependent : 마스터 테이블에 PK가 존재할 때 자식 입력 허용



## Null
### Null 특성
- Null 은 아직 정의되지 않은 값으로 0이나 공백과는 다른다.
- 공백은 문자, 0은 숫자이다.
- 테이블을 생성할 때 Not Null 또는 PK로 정의되지 않은 모든 데이터 유형은 널값을 포함할 수 있다.
- 널 값을 포함하는 연산의 경우 결과값도 널 값이다.
`Null + 2 = Null, Null * 2 = Null, Null / 2 = Null ...`
- 결과값을 Null 이 아닌 다른 값을 얻고자 할 땐 Nvl, IsNull 함수를 사용한다.
- 널 값의 대상이 숫자인 경우 주로 0으로, 문자인 경우는 공백보단 x 같이 의미없는 문자로 바꾸는 경우가 많다.



## 함수
벤더에서 제공하는 함수인 내장 함수와 사용자가 정의할 수 있는 함수로 나눌 수 있다.
### 내장 함수
#### 단일행 함수
1. Select, Where, Order by 절에서 사용 가능
2. 각 행들에 대해 개별적으로 작용
3. 각각의 행에 대한 조작 결과를 리턴
4. 여러 인자를 입력해도 하나의 결과만 리턴
5. 여러 개의 인수를 가질 수도 있다.
6. 함수의 중첩이 가능

#### 단일행 함수의 종류
- 문자형 함수 : 문자를 입력하면 문자나 숫자를 반환
  - Lower, Upper, Substr, Length, Ltrim, Rtrim, Trim, Ascii
- 숫자형 함수 : 숫자를 입력하면 숫자를 반환
  - Abs, Mod, Round, Trunc, Sign, Chr, Ceil, Floor, Exp, Log, Ln, Power, Cos, Tan
- 날짜형 함수 : DATE 타입 값을 연산
  - Sysdate, Extract, To_number
  - 날짜형 데이터 연산
    - 날짜+숫자=날짜 : 숫자만큼 날을 날짜에 더한다.
    - 날짜-숫자=날짜 : 숫자만큼 날을 날짜에 뺀다.
    - 날짜1-날짜2=날짜수 : 다른 하나의 날짜에서 하나의 날짜를 빼면 일수가 나온다.
    - 날짜+숫자/24=날짜 : 시간을 날짜에 더한다.
    - 날짜+숫자/24/60=날짜 : 분을 날짜에 더한다.
- 변환형 함수 : 문자, 숫자, 날짜형의 값 데이터 타입을 반환
  - To_Number, To_Char, To_date
- Null 관련 함수 : Null을 처리하기 위한 함수
  - Nvl, NullIf, Coalesce
  - Nvl : Null 값을 0으로 치환
- 단일행 Case 표현의 종류
  - Case When 조건 (Then 값 혹은 SQL문) (Else 값 혹은 SQL문) End
  - Decode (조건1, 값1, 조건2, 값2, 디폴트값) : Oracle에서만 사용
- Coalesce 함수
  - Coalesce(표현식1, 표현식2, ...)
  - Null 이 아닌 최초의 표현식을 나타낸다.
  - 모든 표현식이 Null 이라면 Null을 나타낸다.

#### 단일행 함수의 특징
- Select, Where, Order by, Update Set 절에서 사용 가능
- 각 행에 대해 개별적으로 작용하여 데이터 값들을 조작하고 각각의 행에 대한 조작 결과를 반환한다.
- 여러 인자를 입력해도 하나의 결과만 리턴한다.
- 함수의 인자로 상수, 변수, 표현식이 사용 가능하고 하나의 인수 또는 여러 개의 인수를 가질 수도 있다.
- 특별한 경우가 아니라면 함수의 인자로 함수를 사용한느 함수의 중첩이 가능

#### 단일행 Null 관련 함수
1. Nvl(표현식1, 표현식2), IsNull(표현식1, 표현식2) : 표현식1의 결과값이 Null 이면 표현식2의 값을 출력 - 다만 표현식1과 표현식2의 결과 데이터 타입이 같아야 한다.
2. NullIf(표현식1, 표현식2) : 표현식1과 표현식2가 같으면 Null, 같지 않으면 표현식1을 리턴한다.
3. Coalesce(표현식1, 표현식2, ...) : 임의의 개수 표현식에서 Null 이 아닌 최초의 표현식을 나타낸다. 모든 표현식이 Null 이면 Null 을 리턴한다.

#### 다중행 함수
- 집계 함수
  - Count, Avg, Sum, Min, Max, Stddev, Variance
- 그룹 함수
  - Rollup, Cube, Grouping Sets
- 윈도우 함수
